<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Dashboard - Azure Graph API</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="#">Azure Graph API</a>
        <div class="navbar-nav ms-auto">
            <a class="nav-link" href="/users">All Users</a>
            <a class="nav-link" href="/logout">Logout</a>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <h2>User Dashboard</h2>

            <!-- User Profile Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h4>User Profile</h4>
                </div>
                <div class="card-body" th:if="${user}">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Display Name:</strong> <span th:text="${user.displayName}"></span></p>
                            <p><strong>Email:</strong> <span th:text="${user.mail}"></span></p>
                            <p><strong>User Principal Name:</strong> <span th:text="${user.userPrincipalName}"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Job Title:</strong> <span th:text="${user.jobTitle ?: 'N/A'}"></span></p>
                            <p><strong>Department:</strong> <span th:text="${user.department ?: 'N/A'}"></span></p>
                            <p><strong>User ID:</strong> <span th:text="${user.id}"></span></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Security Groups Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h4>Security Groups</h4>
                    <button class="btn btn-sm btn-primary" onclick="loadGroups()">Refresh Groups</button>
                </div>
                <div class="card-body">
                    <div id="groupsContent">
                        <div th:if="${user.groups}" th:each="group : ${user.groups}">
                            <div class="badge bg-secondary me-2 mb-2" th:text="${group.displayName}"></div>
                        </div>
                        <p th:if="${user.groups == null or #lists.isEmpty(user.groups)}">No groups found.</p>
                    </div>
                </div>
            </div>

            <!-- Roles Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h4>Directory Roles</h4>
                    <button class="btn btn-sm btn-primary" onclick="loadRoles()">Refresh Roles</button>
                </div>
                <div class="card-body">
                    <div id="rolesContent">
                        <div th:if="${user.roles}" th:each="role : ${user.roles}">
                            <div class="badge bg-success me-2 mb-2" th:text="${role}"></div>
                        </div>
                        <p th:if="${user.roles == null or #lists.isEmpty(user.roles)}">No directory roles found.</p>
                    </div>
                </div>
            </div>

            <!-- All Users Section -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4>All Users Directory</h4>
                    <button class="btn btn-primary" onclick="loadAllUsers()">Load All Users</button>
                </div>
                <div class="card-body">
                    <div id="usersLoadingMessage" class="text-center" style="display: none;">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading users...</p>
                    </div>
                    <div id="usersContent">
                        <p class="text-muted">Click "Load All Users" to fetch the directory.</p>
                    </div>
                </div>
            </div>

            <!-- API Testing Section -->
            <div class="card">
                <div class="card-header">
                    <h4>Test API Endpoints</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <button class="btn btn-info w-100 mb-2" onclick="testEndpoint('/api/user/profile')">
                                Test User Profile API
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-warning w-100 mb-2" onclick="testEndpoint('/api/user/groups')">
                                Test User Groups API
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-success w-100 mb-2" onclick="testEndpoint('/api/user/roles')">
                                Test User Roles API
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-danger w-100 mb-2" onclick="testEndpoint('/api/users')">
                                Test All Users API
                            </button>
                        </div>
                    </div>
                    <div class="mt-3">
                        <textarea id="apiResponse" class="form-control" rows="10" placeholder="API response will appear here..."></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function loadGroups() {
        axios.get('/api/user/groups')
            .then(response => {
                const groupsContent = document.getElementById('groupsContent');
                groupsContent.innerHTML = '';
                if (response.data && response.data.length > 0) {
                    response.data.forEach(group => {
                        const badge = document.createElement('div');
                        badge.className = 'badge bg-secondary me-2 mb-2';
                        badge.textContent = group.displayName;
                        groupsContent.appendChild(badge);
                    });
                } else {
                    groupsContent.innerHTML = '<p>No groups found.</p>';
                }
            })
            .catch(error => {
                console.error('Error loading groups:', error);
                document.getElementById('groupsContent').innerHTML = '<p class="text-danger">Error loading groups.</p>';
            });
    }

    function loadRoles() {
        axios.get('/api/user/roles')
            .then(response => {
                const rolesContent = document.getElementById('rolesContent');
                rolesContent.innerHTML = '';
                if (response.data && response.data.length > 0) {
                    response.data.forEach(role => {
                        const badge = document.createElement('div');
                        badge.className = 'badge bg-success me-2 mb-2';
                        badge.textContent = role;
                        rolesContent.appendChild(badge);
                    });
                } else {
                    rolesContent.innerHTML = '<p>No directory roles found.</p>';
                }
            })
            .catch(error => {
                console.error('Error loading roles:', error);
                document.getElementById('rolesContent').innerHTML = '<p class="text-danger">Error loading roles.</p>';
            });
    }

    function loadAllUsers() {
        const loadingMessage = document.getElementById('usersLoadingMessage');
        const usersContent = document.getElementById('usersContent');

        // Show loading message
        loadingMessage.style.display = 'block';
        usersContent.innerHTML = '';

        axios.get('/api/users')
            .then(response => {
                loadingMessage.style.display = 'none';

                if (response.data && response.data.length > 0) {
                    // Create table
                    const table = document.createElement('table');
                    table.className = 'table table-striped table-hover';

                    // Create header
                    const thead = document.createElement('thead');
                    thead.className = 'table-dark';
                    thead.innerHTML = `
                        <tr>
                            <th>ID</th>
                            <th>LOGIN</th>
                            <th>EMAIL</th>
                            <th>PROFILES</th>
                            <th>CREATED DATE</th>
                            <th>MODIFIED BY</th>
                            <th>STATUS</th>
                            <th>ACTIONS</th>
                        </tr>
                    `;
                    table.appendChild(thead);

                    // Create body
                    const tbody = document.createElement('tbody');
                    response.data.forEach((user, index) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td><strong>${user.displayName || 'N/A'}</strong></td>
                            <td>${user.mail || 'N/A'}</td>
                            <td>
                                <span class="badge bg-primary me-1">${user.userType || 'Member'}</span>
                                ${user.roles && user.roles.length > 0 ?
                                    user.roles.map(role => `<span class="badge bg-warning me-1">${role}</span>`).join('') :
                                    '<span class="badge bg-secondary me-1">User</span>'
                                }
                                ${user.groups && user.groups.length > 0 ?
                                    user.groups.slice(0, 2).map(group => `<span class="badge bg-info me-1">${group.displayName}</span>`).join('') : ''
                                }
                                ${user.groups && user.groups.length > 2 ?
                                    `<span class="badge bg-light text-dark">+${user.groups.length - 2} more</span>` : ''
                                }
                            </td>
                            <td>${formatDate(user.createdDateTime) || 'N/A'}</td>
                            <td>system</td>
                            <td>
                                <span class="badge ${user.accountEnabled !== false ? 'bg-success' : 'bg-danger'}">
                                    ${user.accountEnabled !== false ? 'Activated' : 'Deactivated'}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-info me-1" disabled>
                                    <i class="bi bi-eye"></i> View
                                </button>
                                <button class="btn btn-sm btn-warning me-1" disabled>
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-danger" disabled>
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    table.appendChild(tbody);

                    // Add summary
                    const summary = document.createElement('div');
                    summary.className = 'alert alert-info mt-3';
                    summary.innerHTML = `<strong>Total Users:</strong> ${response.data.length}`;

                    usersContent.appendChild(summary);
                    usersContent.appendChild(table);
                } else {
                    usersContent.innerHTML = '<div class="alert alert-warning">No users found in the directory.</div>';
                }
            })
            .catch(error => {
                loadingMessage.style.display = 'none';
                console.error('Error loading users:', error);
                usersContent.innerHTML = `<div class="alert alert-danger">Error loading users: ${error.message}</div>`;
            });
    }

    function formatDate(dateString) {
        if (!dateString) return null;
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB', {
                day: '2-digit',
                month: '2-digit',
                year: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            }).replace(',', '');
        } catch (e) {
            return null;
        }
    }

    function testEndpoint(endpoint) {
        axios.get(endpoint)
            .then(response => {
                document.getElementById('apiResponse').value = JSON.stringify(response.data, null, 2);
            })
            .catch(error => {
                document.getElementById('apiResponse').value = 'Error: ' + error.message;
            });
    }
</script>
</body>
</html>