<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Dashboard - Azure Graph API</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="#">Azure Graph API</a>
        <div class="navbar-nav ms-auto">
            <a class="nav-link" href="/logout">Logout</a>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <h2>User Dashboard</h2>

            <!-- User Profile Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h4>User Profile</h4>
                </div>
                <div class="card-body" th:if="${user}">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Display Name:</strong> <span th:text="${user.displayName}"></span></p>
                            <p><strong>Email:</strong> <span th:text="${user.mail}"></span></p>
                            <p><strong>User Principal Name:</strong> <span th:text="${user.userPrincipalName}"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Job Title:</strong> <span th:text="${user.jobTitle ?: 'N/A'}"></span></p>
                            <p><strong>Department:</strong> <span th:text="${user.department ?: 'N/A'}"></span></p>
                            <p><strong>User ID:</strong> <span th:text="${user.id}"></span></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Security Groups Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h4>Security Groups</h4>
                    <button class="btn btn-sm btn-primary" onclick="loadGroups()">Refresh Groups</button>
                </div>
                <div class="card-body">
                    <div id="groupsContent">
                        <div th:if="${user.groups}" th:each="group : ${user.groups}">
                            <div class="badge bg-secondary me-2 mb-2" th:text="${group.displayName}"></div>
                        </div>
                        <p th:if="${user.groups == null or #lists.isEmpty(user.groups)}">No groups found.</p>
                    </div>
                </div>
            </div>

            <!-- Roles Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h4>Directory Roles</h4>
                    <button class="btn btn-sm btn-primary" onclick="loadRoles()">Refresh Roles</button>
                </div>
                <div class="card-body">
                    <div id="rolesContent">
                        <div th:if="${user.roles}" th:each="role : ${user.roles}">
                            <div class="badge bg-success me-2 mb-2" th:text="${role}"></div>
                        </div>
                        <p th:if="${user.roles == null or #lists.isEmpty(user.roles)}">No directory roles found.</p>
                    </div>
                </div>
            </div>

            <!-- API Testing Section -->
            <div class="card">
                <div class="card-header">
                    <h4>Test API Endpoints</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <button class="btn btn-info w-100 mb-2" onclick="testEndpoint('/api/user/profile')">
                                Test User Profile API
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-warning w-100 mb-2" onclick="testEndpoint('/api/user/groups')">
                                Test User Groups API
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-success w-100 mb-2" onclick="testEndpoint('/api/user/roles')">
                                Test User Roles API
                            </button>
                        </div>
                    </div>
                    <div class="mt-3">
                        <textarea id="apiResponse" class="form-control" rows="10" placeholder="API response will appear here..."></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function loadGroups() {
        axios.get('/api/user/groups')
            .then(response => {
                const groupsContent = document.getElementById('groupsContent');
                groupsContent.innerHTML = '';
                if (response.data && response.data.length > 0) {
                    response.data.forEach(group => {
                        const badge = document.createElement('div');
                        badge.className = 'badge bg-secondary me-2 mb-2';
                        badge.textContent = group.displayName;
                        groupsContent.appendChild(badge);
                    });
                } else {
                    groupsContent.innerHTML = '<p>No groups found.</p>';
                }
            })
            .catch(error => {
                console.error('Error loading groups:', error);
                document.getElementById('groupsContent').innerHTML = '<p class="text-danger">Error loading groups.</p>';
            });
    }

    function loadRoles() {
        axios.get('/api/user/roles')
            .then(response => {
                const rolesContent = document.getElementById('rolesContent');
                rolesContent.innerHTML = '';
                if (response.data && response.data.length > 0) {
                    response.data.forEach(role => {
                        const badge = document.createElement('div');
                        badge.className = 'badge bg-success me-2 mb-2';
                        badge.textContent = role;
                        rolesContent.appendChild(badge);
                    });
                } else {
                    rolesContent.innerHTML = '<p>No directory roles found.</p>';
                }
            })
            .catch(error => {
                console.error('Error loading roles:', error);
                document.getElementById('rolesContent').innerHTML = '<p class="text-danger">Error loading roles.</p>';
            });
    }

    function testEndpoint(endpoint) {
        axios.get(endpoint)
            .then(response => {
                document.getElementById('apiResponse').value = JSON.stringify(response.data, null, 2);
            })
            .catch(error => {
                document.getElementById('apiResponse').value = 'Error: ' + error.message;
            });
    }
</script>
</body>
</html>